<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Vrtta Sustainability Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --card-border:#e5e7eb; --text:#111827; --muted:#6b7280; --chip:#f3f4f6; --brand:#0ea5e9;
      --ai-bg:#ecfdf5; --ai-border:#34d399;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:var(--text);background:#fafafa}
    h1{margin:0 0 16px}
    h3{margin:0 0 12px}
    .card{border:1px solid var(--card-border);border-radius:16px;padding:16px;margin-bottom:16px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    label{display:block;font-size:14px;margin-top:8px;color:#374151}
    input,select{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--brand);color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .muted{color:var(--muted);font-size:12px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px}
    .chart-box{width:100%;height:300px}
    .chart-box canvas{width:100% !important;height:100% !important;display:block}
    .ai-card{border:1px solid var(--ai-border);background:var(--ai-bg);border-radius:12px;padding:12px;margin-top:12px}
    .ai-card h4{margin:0 0 8px;display:flex;align-items:center;gap:6px;color:#065f46}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid #93c5fd;border-top-color:#2563eb;
      border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle;margin-right:6px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Vrtta Sustainability Dashboard</h1>

  <div class="card">
    <h3>Score a Product</h3>
    <div class="row">
      <div>
        <label>Product Name <input id="product_name" placeholder="Reusable Bottle"/></label>
        <label>Materials (comma-separated) <input id="materials" placeholder="aluminum, plastic"/></label>
        <label>Weight (grams) <input id="weight_grams" type="number" value="300"/></label>
        <label>Transport
          <select id="transport">
            <option value="air">air</option><option value="sea">sea</option>
            <option value="rail">rail</option><option value="road">road</option>
          </select>
        </label>
        <label>Packaging
          <select id="packaging">
            <option>recyclable</option><option>biodegradable</option>
            <option>compostable</option><option>none</option><option>other</option>
          </select>
        </label>
      </div>
      <div>
        <label>GWP (kg COâ‚‚e, est) <input id="gwp" type="number" step="0.1" value="5.0"/></label>
        <label>Cost (USD or local) <input id="cost" type="number" step="0.1" value="10.0"/></label>
        <label>Circularity (%) <input id="circularity" type="number" step="0.1" value="80.0"/></label>
        <div class="row">
          <div><label>Weight GWP <input id="w_gwp" type="number" step="0.05" value="0.5"/></label></div>
          <div><label>Weight Circularity <input id="w_circularity" type="number" step="0.05" value="0.3"/></label></div>
        </div>
        <label>Weight Cost <input id="w_cost" type="number" step="0.05" value="0.2"/></label>
      </div>
    </div>
    <div style="margin-top:12px;">
      <button id="scoreBtn">Compute Score</button>
      <span class="muted">Weights auto-normalize to sum = 1</span>
    </div>
    <div id="scoreResult" style="margin-top:12px;"></div>
  </div>

  <div class="row">
    <div class="card">
      <h3>All Products â€” Score Distribution</h3>
      <div class="chart-box"><canvas id="scoresChart"></canvas></div>
    </div>
    <div class="card">
      <h3>Ratings Breakdown</h3>
      <div class="chart-box"><canvas id="ratingsChart"></canvas></div>
    </div>
  </div>

  <div class="card">
    <h3>Top Issues</h3>
    <div id="topIssues" class="chips"></div>
  </div>

  <div class="card">
    <h3>Recent Submissions</h3>
    <div id="history"></div>
  </div>

<script>
const api=(path,opts={})=>fetch(path,{headers:{'Content-Type':'application/json'},...opts});

async function refresh(){
  const h=await (await api('/history?limit=100')).json();
  const histDiv=document.getElementById('history');
  histDiv.innerHTML=h.map(r=>`
    <div class="card" style="margin:8px 0;">
      <b>${r.product_name}</b>
      <span class="chip">Score: ${r.sustainability_score}</span>
      <span class="chip">Rating: ${r.rating}</span>
      <div class="muted">${new Date(r.created_at).toLocaleString()}</div>
      <div class="chips">
        ${r.materials.map(m=>`<span class="chip">${m}</span>`).join('')}
        <span class="chip">GWP ${r.gwp}</span>
        <span class="chip">Circ ${r.circularity}%</span>
        <span class="chip">Cost ${r.cost}</span>
        <span class="chip">T: ${r.transport}</span>
        <span class="chip">P: ${r.packaging}</span>
      </div>
    </div>`).join('')||'<div class="muted">No data yet.</div>';

  const s=await (await api('/score-summary')).json();
  document.getElementById('topIssues').innerHTML=
    (s.top_issues||[]).map(x=>`<span class="chip">${x}</span>`).join('')||'<span class="muted">No issues yet.</span>';

  const scores=h.map(x=>x.sustainability_score).reverse();
  buildScoresChart(scores);
  buildRatingsChart(s.ratings||{});
}

let scoresChart,ratingsChart;
function buildScoresChart(data){
  const ctx=document.getElementById('scoresChart').getContext('2d');
  if(scoresChart)scoresChart.destroy();
  scoresChart=new Chart(ctx,{
    type:'line',
    data:{labels:data.map((_,i)=>i+1),datasets:[{label:'Score',data}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}}}
  });
}
function buildRatingsChart(obj){
  const ctx=document.getElementById('ratingsChart').getContext('2d');
  if(ratingsChart)ratingsChart.destroy();
  ratingsChart=new Chart(ctx,{
    type:'bar',
    data:{labels:Object.keys(obj),datasets:[{label:'Count',data:Object.values(obj)}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}
  });
}

document.getElementById('scoreBtn').addEventListener('click',async()=>{
  const el=document.getElementById('scoreResult');
  el.innerHTML=`
    <div class="chips"><span class="chip">Scoringâ€¦</span></div>
    <div style="margin-top:8px;">
      <b>Rule-Based Suggestions</b>
      <ul id="ruleList"><li class="muted"><span class="spinner"></span>Computing rule-based suggestionsâ€¦</li></ul>
    </div>
    <div class="ai-card">
      <h4><span id="aiSpinner" class="spinner"></span>ðŸ¤– AI Suggestions (ChatGPT)</h4>
      <div id="aiBlock" class="muted">Generating AI suggestionsâ€¦</div>
    </div>`;

  const payload={
    product_name:document.getElementById('product_name').value,
    materials:document.getElementById('materials').value.split(',').map(s=>s.trim()).filter(Boolean),
    weight_grams:+document.getElementById('weight_grams').value,
    transport:document.getElementById('transport').value,
    packaging:document.getElementById('packaging').value,
    gwp:+document.getElementById('gwp').value,
    cost:+document.getElementById('cost').value,
    circularity:+document.getElementById('circularity').value,
    weights:{
      gwp:+document.getElementById('w_gwp').value,
      circularity:+document.getElementById('w_circularity').value,
      cost:+document.getElementById('w_cost').value
    }
  };

  const res=await api('/score',{method:'POST',body:JSON.stringify(payload)});
  const out=await res.json();
  if(!res.ok){el.innerHTML=`<div style="color:#b91c1c;">Error: ${out.error} â€“ ${out.details?.join('; ')}</div>`;return;}

  el.querySelector('.chips').innerHTML=`
    <span class="chip">Score ${out.sustainability_score}</span>
    <span class="chip">Rating ${out.rating}</span>
    <span class="chip">Weights GWP ${out.weights.gwp.toFixed(2)}</span>
    <span class="chip">Circ ${out.weights.circularity.toFixed(2)}</span>
    <span class="chip">Cost ${out.weights.cost.toFixed(2)}</span>`;

  const ruleBased=out.rule_suggestions||[];
  const ruleList=document.getElementById('ruleList');
  ruleList.innerHTML=ruleBased.length?ruleBased.map(s=>`<li>${s}</li>`).join(''):'<li class="muted">No rule-based tips.</li>';

  const aiBased=out.ai_suggestions||[];
  const aiBlock=document.getElementById('aiBlock');
  if(aiBased.length){
    aiBlock.innerHTML=`<ul>${aiBased.map(s=>`<li>${s}</li>`).join('')}</ul>`;
  }else{
    aiBlock.innerHTML=`No AI suggestions returned. Ensure the server was started with
      <code>LLM_PROVIDER="openai"</code> and a valid <code>LLM_API_KEY</code>.`;
  }

  // remove spinner once AI section loaded
  const sp=document.getElementById('aiSpinner');
  if(sp) sp.remove();

  refresh();
});

refresh();
</script>
</body>
</html>
